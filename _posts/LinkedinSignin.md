---
title: "LinkedinAPI-OAUTH2.0 in R"
author: "Aruna Malla"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    keep_md: yes
  pdf_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(ROAuth)
library(httr)
library(RSelenium)
library(xml2) # to read the xml tree of the r_search_xpath

```

## R Markdown

An example for calling Linkedin API from R, using 3-legged OAUTH 2.0
tokens. This R program, uses HTTR to make REST API calls to Linkedin.
see <https://linkedin.com/developers> for more information on Linkedin
API V2

Linkedin API V2 - restricts user access based on privileges granted. To
get legal access to the V2 end points - please create an APP - as
mentioned below: 1. Login to Linkedin 2. Go to Linkedin.com/developers
3. Click on Create APP 4. A client ID, Secret - automatically gets
generated by Linkedin 5. provide the OAUTH 2.0 redirect url 6. Select
"Sign in with Linkedin API V2" product - this gives access to /me,
/profile

```{r }
#set httr_oauth_cache to TRUE
#set httr_oob_default to TRUE
options(httr_oob_default = "TRUE")
options(httr_oauth_cache = "TRUE")

```

## defining end points

HTTR library contains many commonly used endpoints such as Git, Google,
Linkedin etc. The linekdin endpoint - is for OAUTH 1.0 and its pointed
to old auth urls, which is shown below:

```{r}
linkedin_auth1 <- oauth_endpoint("requestToken", "authorize", "accessToken",
                           base_url = "https://api.linkedin.com/uas/oauth"
)

```

define the linkedin - OAUTH endpoint as below, to use the latest auth
and access urls:

```{r}
linkedin <- oauth_endpoint(
  authorize = "https://www.linkedin.com/oauth/v2/authorization",
  access = "https://reinventanalytics.com/"
)
```

set the client ID, Secret values as variables, for later use in
initializing OAUTH tokens Scope - is a privilege granted to you.
Linkedin grants 2 privilages/scopes "r_liteprofile", "r_basicprofile" in
this example, I am using r_liteprofile" as scope. Redirect URL - is your
website url, where you want to receive the Authorization code.
Authorization Code is required to create OAUTH 2.0 token

```{r, echo=FALSE}
r_client_secret= "OB50xsWxXLtELTIc"
```

```{r}

r_client_id = "789fdykj5bh7lr"
r_redirect_uri = "https://reinventanalytics.com/"
r_scope = "r_liteprofile"

#use this r_nonce as state parameter value, to track the responses with the same value
r_nonce <- as.numeric(as.POSIXct(Sys.time()))

```

call oauth_app function with app name, key - client ID, secret - client
secret, redirect url; all these values should match with values in your
Linkedin APP page.

```{r}

oauth_app(appname="myjobsearch", key=r_client_id, secret = r_client_secret, redirect_uri = r_redirect_uri) -> linkedin_app
```

Create OAUTH 2.0 token

```{r}
oauth2.0_token(
  endpoint= linkedin,
  app=linkedin_app,
  scope = r_scope,
  user_params = NULL,
  type = NULL,
  use_oob = TRUE,
  oob_value = linkedin_app$redirect_uri,
  as_header = TRUE,
  use_basic_auth = FALSE,
  cache = getOption("httr_oauth_cache"),
  config_init = list(),
  client_credentials = FALSE,
  credentials = NULL,
  query_authorize_extra = list()
) -> at2
at2
```

this function call, opens a new tab in the default browser, the redirect
url we gave in our token will be appended with the Authorization Code.

Since this is a 3-legged OAUTH, we need to copy the Authorization Code:
from the redirect url in the browser tab.

Configure the token - for later use in the HTTR::GET calls.

```{r}

#pass at2 as token in following url requests
linkedin_token <- config(token = at2)
linkedin_token
```

Making a GET call to /jobs. with token (at2) configured.

Print response object of the GET call.

To check whether the configured token is used in the GET calls. the
actual url used (after any redirects), the http status, the file
(content) type, the size, and if it's a text file, the first few lines
of output.

```{r}
httr::GET(url = "https://www.linkedin.com/jobs/",user_agent(agent = "Rstudio"),config(token = at2),
          content_type(type = "text/html"), verbose()) -> r_jobs_main

#GET call response details are as follows:
r_jobs_main

content(r_jobs_main)-> r_jobs_main_resp
```

Authorization: Bearer

user agent : RStudio

indicates that our oauth token is being used by the GET calls.

lets pull out important parts of the response with various helper
methods, or dig directly into the object:

```{r}
status_code (r_jobs_main)

headers(r_jobs_main)
stop_for_status(r_jobs_main)
```
